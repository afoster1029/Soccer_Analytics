---
title: "Predicting MLS Matches using Machine Learning Techniques"
author: "Alex Foster, Chris Bajek, Webster An"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
abstract: "Predicting the outcome or different statistics of sports is a massive market for betting and gambling. Additionally, in crisis such as a global pandemic, predicting results can be crucial for determining how the season would have ended. For this project, we will use different machine learning techniques that we learned in Statistical Machine Learning to determine how to predict the outcome of matches in the Major Socceer League. Using data on the MLS season from 2012-2019 we hope to predict the results of some of the intial matches of the 2020 season."

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load packages
library(ggplot2)
library(dplyr)
library(janitor)
library(reshape2)
library(tidyr)
library(readr)
library(lubridate)
library(Matrix)
library(DataCombine)
library(rsample)
library(caret)
library(broom)

```

## Introduction

Due to the COVID-19 pandemic in 2020, the majority sport leagues across the world have halted their seasons. This has lead to varying decisions of how to proceed. Since soccer does not have playoffs, the final standings of the league dictate which teams are promoted or relegated. This can have a massive finicial effect on teams in relegation and promotion positions. Some leagues have decided to cancel the rest of the remaining season, while other leagues, like France's Ligue 1, have decided to end the league as it stands, crowning the current 1st place team. This decision has resulted in several lawsuits. 

In the USA, the Major League Soccer does not implement promotion or relegation and uses the playoff system like many other American sports leagues. However, due to the chaoes in European soccer leagues, we wanted to see if we could create a model that could predict the outcome of MLS matches. We intend to do this by predicting the number of goals each team will play in a match and compute the result based on thsoe predictions. 

## Data 

```{R,echo=FALSE, message=FALSE}
MLS <- read_csv("USA.csv")

# create datetime objects using lubridate. 
# also initialize variables for each game that will measure home/awayteam goals per game and home/away team goals conceded per game
MLS <- MLS %>%
  mutate(HAGG = 0.0, AAGG = 0.0, HACG = 0.0, AACG = 0.0, HTP=0, ATP = 0,TG = HG + AG, Datetime = dmy(Date),  month = month(Datetime)) %>%
  select(Country, League, Season, Datetime, Home, Away, HG, AG, Res, HAGG, AAGG, AACG, HACG,HTP,ATP,TG, PH, PD, PA)

```

The dataset that we used provides brief overall match statistics of all MLS matches from 2012-2020. The dataset was provided by http://www.football-data.co.uk/usa.php, which is used primarily to compute betting odds. As a result our dataset contains not only the relevant match information but also the betting odds for each potential result. Since 2012 there have been 2794 matches. The graph below represents the number of number of matches for each season. The increase of matches in each year is due to the constant expansion in the MLS. This means that in each new season there are brand new teams with no previous match data. We anticipate this having a negative effect on the performance of our models. 

```{r,echo=FALSE,fig.align='center'}
ggplot(MLS, aes(Season)) + geom_bar() + ylab("Total Games") + ggtitle("MLS Dataset")
```

The initial dataset provided us with the outcome and date of each match, teams playing, number of goals scored by each team and betting odds. We recognized that we would need more explanatory variables. We created a function that would compute the league table prior to a given date. This allowed us to compute each teams average goals scored per game, average goals conceded per game for each match and their position in the league. However, even with our additional explanatory variables we wrangled our dataset to be better designed for predictive modeling. We split each match into two rows. This meant that each row represented a team with that teams relevant information. Ultimately, our plan is to have our response variable be Goals. Our dataset had the the following structure. 

\newline

<table style="border:2px solid black;margin-left:auto;margin-right:auto;">
<tr> <th>  </th> <th> Variable Name </th> <th> Description </th>  </tr>
  <tr> <td align="center"> 3 </td> <td align="center"> Season </td> <td align="center"> Calendar year that a given season occurred (2012 - 2020) </td> </tr>
  <tr> <td align="center"> 4 </td> <td align="center"> Datetime </td> <td align="center"> Represents the date the match was played on (lubridate datetime object) </td> </tr>
  <tr> <td align="center"> 5 </td> <td align="center"> Team </td> <td align="center"> Team that we will predict number of goals for. </td> </tr>
  <tr> <td align="center"> 6 </td> <td align="center"> Opponent </td> <td align="center"> Team's opponent for given match </td> </tr>
  <tr> <td align="center"> 7 </td> <td align="center"> Goals </td> <td align="center"> Team's goals scored in the given match </td> </tr>
  <tr> <td align="center"> 8 </td> <td align="center"> GoalsAllowed </td> <td align="center"> Opponent goals scored in the given match </td> </tr>
  <tr> <td align="center"> 9 </td> <td align="center"> Res </td> <td align="center"> Final result of the match (H/A/T) </td> </tr>
  <tr> <td align="center"> 10 </td> <td align="center"> AGS </td> <td align="center"> Team's average goals per game prior to this match </td> </tr>
  <tr> <td align="right"> 11 </td> <td align="center"> OpAGC </td> <td align="center"> Oppoent's average goals conceded per game prior to this match </td> </tr>
  <tr> <td align="right"> 12 </td> <td align="center"> Position </td> <td align="center">  Team's league position prior to this match </td> </tr>
  <tr> <td align="right"> 13 </td> <td align="center"> OpPosition </td> <td align="center"> Oppoent's league position prior to this match </td> </tr>
  <tr> <td align="right"> 14 </td> <td align="center"> TG </td> <td align="center"> Total goals scored in this match </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> TableDiff </td> <td align="center"> Team's difference in table position with opponent </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> GoalDiff </td> <td align="center"> Team's goal differential prior to this match </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> GoalScCo </td> <td align="center"> The sum of AGS and OpAGC variables </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> HA </td> <td align="center"> Dictates whether the Team is home or away for the given match </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> PH </td> <td align="center"> Betting odds of a home win </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> PD </td> <td align="center"> Betting odds of a draw </td> </tr>
  <tr> <td align="right"> 15 </td> <td align="center"> PA </td> <td align="center"> Betting odds of an away win </td> </tr>
   </table>
   
   
\newline 

```{r, echo=FALSE, cache=TRUE}
# Function that computes the table of the season given a certain date in the season.
# Returns a dataframe that provides stats dependent on the progress of the given season 
compute_table <- function(date, df=USA) {
    # Get only the games that are in the same season and occured before the given date. 
    season = year(date)
    df_subset <- df[which(df$Season == season & df$Datetime < date), ] # get games from that season and up to the given data
    # get team names
    names <- unique(df[which(df$Season==season),]$Home)
    # initialize beginning of season table (stats are all zero)
    table <- data.frame("Team" = names, "Points" = matrix(0,length(names)), "GA" = matrix(0,length(names)), "GF" = matrix(0,length(names)), 'GP' = matrix(0,length(names)))
    if (nrow(df_subset) != 0){
        # Loop through each game and update the explanatory varaibles such as GA, GF, GP. All of these values are dependent on the date of the game. 
        for (row in 1:nrow(df_subset)) {
            current_r =df_subset[row, ]
            # Update info for home team
            home <- current_r$Home
            table$GA[which(table$Team == home)] <- table$GA[which(table$Team == home)] + current_r$AG# GA
            table$GF[which(table$Team == home)] <- table$GF[which(table$Team == home)]+current_r$HG# GF
            table$GP[which(table$Team == home)] <- table$GP[which(table$Team == home)]+1
            
            # Update info for away team
            away <- current_r$Away
            table$GA[which(table$Team == away)] <- table$GA[which(table$Team == away)]+current_r$HG# GA
            table$GF[which(table$Team == away)] <- table$GF[which(table$Team == away)]+current_r$AG# GF
            table$GP[which(table$Team == away)] <- table$GP[which(table$Team == away)]+1
            
            # Award points to winner and for ties. 
            if (current_r$Res == 'H'){ # home wins
              table$Points[which(table$Team == home)] <- table$Points[which(table$Team == home)] + 3
            } else if (current_r$Res == 'A'){ # away wins
              table$Points[which(table$Team == away)] <- table$Points[which(table$Team == away)] + 3
            } else { # draw
              table$Points[which(table$Team == home)] <- table$Points[which(table$Team == home)] + 1
              table$Points[which(table$Team == away)] <- table$Points[which(table$Team == away)] + 1
            }
        }
        # compute goal differential
        table <- table %>%
          mutate('GD' = GF - GA)
        # add AGSG column that represents the avg goals scored per game
        table <- table %>%
          mutate(AGSG = GF / GP)
        # add AGCG column that represents the avg goals conceded per game
        table <- table %>%
          mutate(AGCG = GA / GP)
        # Add position column that indicates what place each team is in. 
        table <- table[with(table,order(table$Points, table$GD)),]
        table$Position <- length(names):1
    }
  return(table)
}
```

```{r, echo=FALSE, cache=TRUE}
# Function computes table for every game and updates the current season stats like Avg goals scored, avg goals conceded and position in the league. 
add_table_stats <- function(df = usa_2012) {
    for (row in 1:nrow(df)){
      game = df[row,]
      # compute table 
      table <- compute_table(game$Datetime, df)
        # add home/away team average stats based on season performance up to that game.
        if (table[1,]$GP != 1){ # if games played is 1 then we don't really want average stats (avoids potential errors)
            if(game$Home %in% table$Team & game$Away %in% table$Team){ # check that both teams are actually in table.
                # home team stats
                df[row,]$HAGG <- table$AGSG[which(table$Team == game$Home)]
                df[row,]$HACG <- table$AGCG[which(table$Team == game$Home)]
                df[row,]$HTP <- table$Position[which(table$Team == game$Home)]
                # away teams stats
                df[row,]$AAGG <- table$AGSG[which(table$Team == game$Away)]
                df[row,]$AACG <- table$AGCG[which(table$Team == game$Away)]
                df[row,]$ATP <- table$Position[which(table$Team == game$Away)]
            }
        }
    }
    return(df)
}
```
 
```{r,echo=FALSE, cache=TRUE}
# initialize final dataframe with 2012 season
USA_final <- add_table_stats(MLS[which(MLS$Season==2012),])
# loop through all other seasons that aren't 2012 and compute season statistics.
for (season in unique(MLS$Season)){
  if (season != 2012){
    updated_df <- add_table_stats(MLS[which(MLS$Season==season),])
    USA_final <- rbind(USA_final, updated_df)
  }
}

write.csv(USA_final,"USA_final.csv", row.names = TRUE)
```

```{r,echo=FALSE,message=FALSE,warning = FALSE, cache=TRUE}
# Read in dataset (avoid long code run)
MLS_df <- read_csv("USA_final.csv",)
MLS_df <- MLS_df[which(MLS_df$PH != 'USA'),]
MLS_df <- subset(MLS_df,select= -c(X1))
```

```{r, echo=FALSE, cache=TRUE}
Home <- MLS_df
Home$Country <- NULL
Home$League <- NULL
Home$Date <- NULL
Home$Time <- NULL
# Home$Away <- NULL
Home$AAGG <- NULL
Home$HACG <- NULL
Home <- Home %>% 
  rename(
    Team = Home,
    Opponent = Away,
    Goals = HG,
    GoalsAllowed = AG,
    Position = HTP,
    AGS = HAGG,
    OpAGC = AACG,
    OpPosition = ATP
    )
Home <- cbind(Home, HA = "H")
Away <- MLS_df
Away$Country <- NULL
Away$League <- NULL
Away$Date <- NULL
Away$Time <- NULL
# Away$Home <- NULL
Away$HAGG <- NULL
Away$AACG <- NULL
Away <- Away %>% 
  rename(
    Team = Away,
    Opponent = Home,
    Goals = AG,
    GoalsAllowed = HG,
    Position = ATP,
    AGS = AAGG,
    OpAGC = HACG,
    OpPosition = HTP,
    Opponent = Home
    )
Away <- cbind(Away, HA = "A")
MLS_final <- rbind(Home, Away)

MLS_final[,"Position"] <- sapply(MLS_final[, "Position"], as.numeric)
MLS_final[,"OpPosition"] <- sapply(MLS_final[, "OpPosition"], as.numeric)
MLS_final[,"AGS"] <- sapply(MLS_final[, "AGS"], as.numeric)
MLS_final[,"OpAGC"] <- sapply(MLS_final[, "OpAGC"], as.numeric)
MLS_final <- MLS_final %>%
  mutate(TableDiff = Position - OpPosition,
         GoalDiff = Goals - GoalsAllowed,
         GoalScCo = AGS + OpAGC)
if ('X1' %in% names(MLS_final)){
  MLS_df[ , !(names(MLS_df) %in% c('X1'))]

}

# Accounting for the fact that Atlanta United has two different names "Atlanta United" and "Atlanta Utd"

# Create replacements data frame
Replaces <- data.frame(from = "Atlanta Utd", to = "Atlanta United")

# Replace patterns and return full data frame
MLS_final1 <- FindReplace(data = MLS_final, Var = "Team", replaceData = Replaces,
                     from = "from", to = "to", exact = FALSE)
MLS_final <- MLS_final1
remove(MLS_final1)
MLS_final <- MLS_final %>% 
  mutate(`PH` = as.numeric(`PH`)) %>% 
  mutate(`PD` = as.numeric(`PD`)) %>% 
  mutate(`PA`= as.numeric(`PA`))
#head(MLS_final)
```

### Data Visualizations

```{r,echo=FALSE}
# Distrbution of goals by season (broken into months)
MLS_final %>% 
  ggplot(aes(x = Goals)) +
  geom_bar(colour = "#0c4c8a") +
  facet_wrap(~Season)+
  theme_minimal() +
  ggtitle("Goals by Season (Broken in to Months)") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion* 


```{r,echo=FALSE}
# Distribution of full time results  by season
MLS_final %>%
  ggplot(aes(x = Res)) +
  geom_bar() +
  scale_fill_hue() +
  facet_wrap(~Season)+
  theme_minimal() +
  ggtitle("Full Time Results by Season") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion* 


```{r,echo=FALSE}
# Total Goals by team
MLS_final %>%
  ggplot(aes(x = Team, y = Goals)) +
  geom_col() +
  scale_fill_hue() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("Total Goals by Team") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion* 



```{r,echo=FALSE}
# Examining average goals scored
MLS_final %>%
  group_by(Team) %>% 
  mutate(avg_goals=AGS/n()) %>% 
  ggplot(aes(x = Team, y = avg_goals)) +
  geom_col() +
  scale_fill_hue() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylab("Average Goals per Game") +
  ggtitle("Average Goals by Team") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion* 



```{r,echo=FALSE}
# Examining relationship between AGS and Position by team
MLS_final %>% 
  ggplot(aes(x=AGS, y=Position)) +
  geom_point(alpha=.5) +
  scale_fill_hue() +
  facet_wrap(~Team)+
  theme_minimal() +
  ggtitle("Average Goals by Table Position") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion* 



```{r,echo=FALSE}
# Number of goals scored by team during home games or away games
MLS_final %>% 
  ggplot(aes(x=HA, y=Goals)) +
  geom_col() +
  scale_fill_hue() +
  facet_wrap(~Team)+
  theme_minimal() +
  ggtitle("Total Goals Scored at Home and Away") +
  theme(plot.title = element_text(hjust = 0.5))
```
*Discussion*

## Modeling: Predict Goals Variable

##### Create training/testing set
```{r, cache=TRUE,include=FALSE}
df_modeling <- MLS_final
df_train <- df_modeling[which(df_modeling$Season != 2019),]
df_train <- df_modeling[which(df_train$Season != 2020),] # remove 2020 from training set.
df_test <- df_modeling[which(df_modeling$Season == 2019),]
cat("Training set contains",nrow(df_train), "rows")
cat('\n')
cat("Training set contains",nrow(df_test), "rows")
```



#### Stepwise Selection of Variables
```{r, cache=TRUE}
set.seed(123) 
split <- trainControl(method = "cv", number = 5)

cv_MLS_all_vars <- train(
  Goals ~ .,
  data = df_train %>% select(-Datetime, -Season, -Res, -TG),
  method = "leapForward", 
  tuneGrid = data.frame(nvmax = 1:61), 
  trControl = split,
  na.action = na.omit
)

cv_MLS_all_vars$results
cv_MLS_all_vars$bestTune
tidy(coef(cv_MLS_all_vars$finalModel,id=60))
```

```{r}
cv_MLS_all_vars$results %>% 
  ggplot() +
  geom_line(aes(x=nvmax,y=RMSE),color="blue") +
  geom_line(aes(x=nvmax,y=RMSE + RMSESD)) +
  geom_line(aes(x=nvmax,y=RMSE - RMSESD))
```



#### OLS
```{r, cache=TRUE}
set.seed(123) 
split <- trainControl(method = "cv", number = 5)

ols_model <- train(
  Goals ~ Team + Opponent + GoalsAllowed,
  data = df_train,
  method = "lm", 
  trControl = split,
  na.action = na.omit
)
summary(ols_model)
```
*Discussion*






<!-- #### Lasso Model -->
<!-- ```{r} -->
<!-- set.seed(253) -->
<!-- MLS_Lasso <- train( -->
<!--     Goals ~ Team + AGS + Position + OpPosition + HA + TableDiff + OpAGC + GoalScCo, -->
<!--     data = MLS_final, -->
<!--     method = "glm", -->
<!--     family = "binomial", -->
<!--     trControl = trainControl(method = "cv", number = 5), -->
<!--     #metric = "Accuracy", -->
<!--     na.action = na.omit -->
<!-- ) -->

<!-- ``` -->




<!-- #### KNN -->

<!-- ```{r} -->

<!-- set.seed(327) -->
<!-- epl_knn <- train( -->
<!--   FTR ~., -->
<!--   data = df_train, -->
<!--   method = "knn", -->
<!--   trControl = trainControl(method = "cv", -->
<!--                            number = 5, -->
<!--                           # summaryFunction = model_stats, -->
<!--                            returnResamp = "all"), -->
<!--   tuneGrid = data.frame(k = c(1:15))) -->


<!-- epl_knn$results -->
<!-- epl_knn$bestTune$k -->
<!-- ``` -->

<!-- *Discussion* The best tuned KNN model (k = 6) yields an accurac of 62.6% lower than all three previous models. -->


